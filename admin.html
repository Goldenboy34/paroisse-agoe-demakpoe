<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration G√©n√©rale | NDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-20 font-sans text-slate-900">

    <!-- NAVBAR ADMIN -->
    <nav class="bg-[#23318E] text-white p-6 shadow-2xl sticky top-0 z-[100] flex justify-between items-center px-6 md:px-12">
        <div>
            <h1 class="font-black uppercase tracking-tighter text-xl leading-none">Grand Secr√©tariat NDA</h1>
            <span class="text-[8px] opacity-60 uppercase font-bold tracking-widest">Contr√¥le Total de la Paroisse</span>
        </div>
        <div class="flex gap-4">
            <a href="dashboard.html" class="bg-white/10 px-6 py-2 rounded-full text-[10px] font-black hover:bg-white/20 transition uppercase tracking-widest border border-white/20">Mon Espace</a>
            <button id="logoutBtn" class="bg-red-600/20 text-red-400 px-6 py-2 rounded-full text-[10px] font-black hover:bg-red-600 hover:text-white transition uppercase border border-red-600/20">D√©connexion</button>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- COLONNE GAUCHE : GESTION FLUX -->
        <div class="lg:col-span-8 space-y-8">
            
            <!-- 1. RADAR DES MEMBRES -->
            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border">
                <div class="p-6 bg-[#23318E] text-white flex justify-between items-center">
                    <h2 class="text-sm font-black uppercase tracking-widest">Radar des Membres</h2>
                    <div class="bg-green-500 px-3 py-1 rounded-full text-[9px] font-black uppercase">Activit√© R√©cente</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 font-black uppercase text-slate-400 border-b">
                            <tr><th class="p-4">Utilisateur</th><th class="p-4">Dernier Passage</th><th class="p-4">Statut</th><th class="p-4 text-right">Action</th></tr>
                        </thead>
                        <tbody id="userMonitoringTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. VALIDATION MESSES -->
            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-sm font-black uppercase tracking-widest text-[#23318E]">Demandes de Messes</h2>
                    <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-1 rounded-lg font-bold">√Ä TRAITER</span>
                </div>
                <div id="adminTableMesses" class="divide-y divide-slate-50 max-h-[400px] overflow-y-auto p-2">
                    <!-- Inject√© par JS -->
                </div>
            </div>

            <!-- 3. VALIDATION DONS -->
            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border">
                <div class="p-6 border-b bg-green-50 flex justify-between items-center">
                    <h2 class="text-sm font-black uppercase tracking-widest text-green-700">Dons & D√Æmes Re√ßus</h2>
                    <span class="text-2xl">üí∞</span>
                </div>
                <div id="adminTableDons" class="divide-y divide-slate-50 p-2">
                    <!-- Inject√© par JS -->
                </div>
            </div>
        </div>

        <!-- COLONNE DROITE : PUBLICATIONS -->
        <div class="lg:col-span-4 space-y-8">
            
            <!-- 4. PUBLIER ANNONCE -->
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">üì¢ Publier une Annonce</h3>
                <form id="formAdminAnnonce" class="space-y-4">
                    <input type="text" id="annTitre" placeholder="Titre (ex: R√©union Chorale)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm border focus:border-blue-500" required>
                    <select id="annPriorite" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm border">
                        <option value="normal">Priorit√© Normale</option>
                        <option value="urgent">Urgent üö®</option>
                    </select>
                    <textarea id="annContenu" placeholder="Message court..." class="w-full p-4 bg-slate-50 rounded-2xl h-24 text-sm border outline-none" required></textarea>
                    <button type="submit" class="w-full bg-[#23318E] text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition">Diffuser</button>
                </form>
            </div>

            <!-- 5. LITURGIE DU JOUR -->
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-blue-100">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">üìñ Parole de Dieu</h3>
                <form id="formLiturgie" class="space-y-4">
                    <input type="date" id="litDate" class="w-full p-3 bg-slate-50 rounded-xl text-xs border" required>
                    <select id="litCouleur" class="w-full p-3 bg-slate-50 rounded-xl text-xs outline-none border">
                        <option value="VERT">VERT</option><option value="BLANC">BLANC</option><option value="ROUGE">ROUGE</option><option value="VIOLET">VIOLET</option>
                    </select>
                    <input type="text" id="litTitreJour" placeholder="Nom du jour" class="w-full p-3 bg-slate-50 rounded-xl text-xs border outline-none">
                    <input type="text" id="litEvTitre" placeholder="Titre √âvangile" class="w-full p-3 bg-slate-50 rounded-xl text-xs border outline-none">
                    <textarea id="litEvTexte" placeholder="Texte de l'√âvangile..." class="w-full p-3 bg-slate-50 rounded-xl h-20 text-[10px] outline-none border"></textarea>
                    <button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-[10px] tracking-widest">Mettre √† jour la Parole</button>
                </form>
            </div>

            <!-- 6. COUNTDOWN PROCHAINE MESSE -->
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-red-100">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">‚è±Ô∏è R√©gler Prochaine Messe</h3>
                <form id="formCelebration" class="space-y-4">
                    <input type="text" id="celNom" placeholder="Nom (Ex: Messe du Dimanche)" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none text-sm" required>
                    <input type="datetime-local" id="celDate" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none text-sm" required>
                    <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg">Lancer le compte √† rebours</button>
                </form>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Logique sp√©cifique Admin (Initialisation apr√®s chargement de script.js)
        window.addEventListener('DOMContentLoaded', async () => {
            // S√©curit√© : V√©rifier si Admin
            const { data: { user } } = await _supabase.auth.getUser();
            const { data: profile } = await _supabase.from('profiles').select('role').eq('id', user.id).single();
            
            if (profile.role !== 'admin') {
                window.location.href = 'dashboard.html';
                return;
            }

            // Charger les donn√©es
            fetchMessesAdmin();
            fetchDonsAdmin();
            monitorUsersAdmin();
            initAdminForms();
        });

        async function fetchMessesAdmin() {
            const { data } = await _supabase.from('demandes_messes').select('*').order('created_at', {ascending: false});
            document.getElementById('adminTableMesses').innerHTML = data.map(m => `
                <div class="flex justify-between items-center p-4 hover:bg-slate-50 transition border-b">
                    <div class="text-[10px]">
                        <div class="font-black uppercase text-slate-800">${m.nom_beneficiaire}</div>
                        <div class="text-slate-400 font-bold">${m.type_priere} ‚Ä¢ ID: ${m.transaction_id}</div>
                    </div>
                    ${m.statut_paiement === 'en_attente' 
                        ? `<button onclick="validerAction('demandes_messes', '${m.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase">Valider</button>` 
                        : `<span class="text-green-600 font-black text-[9px] uppercase italic">Confirm√© ‚úÖ</span>`}
                </div>
            `).join('');
        }

        async function fetchDonsAdmin() {
            const { data } = await _supabase.from('dons').select('*, profiles(username)').order('created_at', {ascending: false});
            document.getElementById('adminTableDons').innerHTML = data.map(d => `
                <div class="flex justify-between items-center p-4 hover:bg-slate-50 border-b">
                    <div class="text-[10px]">
                        <div class="font-black uppercase text-slate-800">${d.profiles?.username || 'Utilisateur'}</div>
                        <div class="text-green-600 font-bold">${d.montant} FCFA ‚Ä¢ ${d.type_don}</div>
                    </div>
                    ${d.statut === 'en_attente' 
                        ? `<button onclick="validerAction('dons', '${d.id}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase">Encaisser</button>` 
                        : `<span class="text-green-600 font-black text-[9px] uppercase italic">V√©rifi√© ‚úÖ</span>`}
                </div>
            `).join('');
        }

        async function monitorUsersAdmin() {
            const { data: users } = await _supabase.from('profiles').select('*').order('last_seen', { ascending: false });
            document.getElementById('userMonitoringTable').innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-4">
                        <div class="font-black text-slate-800 text-[11px] uppercase">${u.username}</div>
                        <div class="text-[8px] text-slate-400 font-bold">${u.role.toUpperCase()}</div>
                    </td>
                    <td class="p-4 text-[9px] font-bold text-slate-500">${new Date(u.last_seen).toLocaleString()}</td>
                    <td class="p-4">
                        <span class="text-slate-300 font-bold text-[8px] uppercase">${u.is_active ? '‚úÖ Actif' : 'üö´ Bloqu√©'}</span>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="toggleUserStatus('${u.id}', ${!u.is_active})" class="px-3 py-1.5 rounded-lg text-[8px] font-black ${u.is_active ? 'bg-red-50 text-red-600' : 'bg-green-600 text-white'}">
                            ${u.is_active ? 'BLOQUER' : 'ACTIVER'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function initAdminForms() {
            document.getElementById('formAdminAnnonce').onsubmit = async (e) => {
                e.preventDefault();
                await _supabase.from('annonces').insert([{ titre: document.getElementById('annTitre').value, contenu: document.getElementById('annContenu').value, priorite: document.getElementById('annPriorite').value }]);
                alert("Annonce publi√©e !"); location.reload();
            };

            document.getElementById('formLiturgie').onsubmit = async (e) => {
                e.preventDefault();
                const d = { 
                    date_jour: document.getElementById('litDate').value, 
                    couleur: document.getElementById('litCouleur').value,
                    titre_jour: document.getElementById('litTitreJour').value,
                    evangile_titre: document.getElementById('litEvTitre').value,
                    evangile_texte: document.getElementById('litEvTexte').value
                };
                await _supabase.from('liturgie_maison').upsert([d]);
                alert("Liturgie mise √† jour !"); location.reload();
            };

            document.getElementById('formCelebration').onsubmit = async (e) => {
                e.preventDefault();
                await _supabase.from('celebrations').insert([{ nom_celebration: document.getElementById('celNom').value, date_heure: document.getElementById('celDate').value }]);
                alert("Countdown mis √† jour !"); location.reload();
            };
        }

        async function validerAction(table, id) {
            const column = table === 'dons' ? 'statut' : 'statut_paiement';
            await _supabase.from(table).update({ [column]: 'confirme' }).eq('id', id);
            location.reload();
        }

        async function toggleUserStatus(id, status) {
            await _supabase.from('profiles').update({ is_active: status }).eq('id', id);
            location.reload();
        }
    </script>
</body>
</html>