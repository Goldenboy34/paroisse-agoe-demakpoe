<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secr√©tariat Pro | NDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-20 font-sans">

    <!-- NAVBAR -->
    <nav class="bg-[#23318E] text-white p-6 shadow-xl sticky top-0 z-50 flex justify-between items-center">
        <div>
            <h1 class="font-black uppercase tracking-tighter text-xl leading-none">Secr√©tariat NDA</h1>
            <span class="text-[8px] opacity-60 uppercase font-bold tracking-widest">Gestion Administrative Num√©rique</span>
        </div>
        <a href="dashboard.html" class="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-white/20 transition uppercase tracking-widest">Dashboard Fid√®le</a>
    </nav>

    <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-12">

        <!-- SECTION 1 : PUBLICATION DE LA LITURGIE (NOUVEAU) -->
        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-blue-100">
            <div class="p-8 bg-blue-50 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-black text-blue-900 uppercase italic">Publication de la Liturgie</h2>
                    <p class="text-[10px] text-blue-400 font-bold uppercase mt-1">√âdition des textes sacr√©s du jour</p>
                </div>
                <span class="text-3xl">üìñ</span>
            </div>
            
            <form id="formLiturgie" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2 mb-1 block">Couleur Liturgique</label>
                        <select id="litCouleur" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-900">
                            <option value="VERT">VERT (Temps Ordinaire)</option>
                            <option value="BLANC">BLANC (F√™tes/Solennit√©s)</option>
                            <option value="ROUGE">ROUGE (Martyrs/Esprit Saint)</option>
                            <option value="VIOLET">VIOLET (Avent/Car√™me)</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2 mb-1 block">Titre du Jour</label>
                        <input type="text" id="litTitreJour" placeholder="Ex: 22√®me Dimanche du Temps Ordinaire" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Lecture 1 -->
                    <div class="space-y-3">
                        <input type="text" id="litL1Titre" placeholder="Titre 1√®re Lecture" class="w-full p-3 bg-gray-50 border rounded-xl font-bold text-sm">
                        <textarea id="litL1Texte" placeholder="Texte de la 1√®re Lecture..." class="w-full p-4 bg-gray-50 border rounded-xl h-32 text-xs italic"></textarea>
                    </div>
                    <!-- Psaume -->
                    <div class="space-y-3">
                        <input type="text" id="litPsTitre" placeholder="Titre du Psaume" class="w-full p-3 bg-gray-50 border rounded-xl font-bold text-sm">
                        <textarea id="litPsTexte" placeholder="Texte du Psaume..." class="w-full p-4 bg-gray-50 border rounded-xl h-32 text-xs italic"></textarea>
                    </div>
                    <!-- Lecture 2 -->
                    <div class="space-y-3">
                        <input type="text" id="litL2Titre" placeholder="Titre 2√®me Lecture (Optionnel)" class="w-full p-3 bg-gray-50 border rounded-xl font-bold text-sm">
                        <textarea id="litL2Texte" placeholder="Texte de la 2√®me Lecture..." class="w-full p-4 bg-gray-50 border rounded-xl h-32 text-xs italic"></textarea>
                    </div>
                    <!-- √âvangile -->
                    <div class="space-y-3">
                        <input type="text" id="litEvTitre" placeholder="Titre de l'√âvangile" class="w-full p-3 bg-gray-50 border rounded-xl font-bold text-sm">
                        <textarea id="litEvTexte" placeholder="Texte de l'√âvangile..." class="w-full p-4 bg-gray-50 border rounded-xl h-32 text-xs italic"></textarea>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-[#23318E] text-white py-5 rounded-2xl font-black uppercase tracking-[0.2em] shadow-xl hover:bg-green-600 transition-all">Diffuser la Parole de Dieu</button>
            </form>
        </div>

        <!-- SECTION 2 : VALIDATION DES MESSES -->
        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border">
            <div class="p-8 bg-white border-b flex justify-between items-center">
                <h2 class="text-xl font-black text-blue-900 uppercase italic">Intentions de Messes</h2>
                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black uppercase">Validation Re√ßus</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400">
                        <tr>
                            <th class="p-6">B√©n√©ficiaire</th>
                            <th class="p-6">R√©f. Transaction</th>
                            <th class="p-6">Montant</th>
                            <th class="p-6 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminTable" class="divide-y text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- SECTION 3 : SURVEILLANCE DES MEMBRES -->
        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border">
            <div class="p-8 bg-[#23318E] text-white flex justify-between items-center">
                <h2 class="text-xl font-black uppercase tracking-widest">Radar des Membres</h2>
                <div class="bg-green-500 px-4 py-1 rounded-full text-[10px] font-black animate-pulse shadow-lg">LIVE</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400">
                        <tr>
                            <th class="p-6">Membre</th>
                            <th class="p-6">Activit√©</th>
                            <th class="p-6">Statut</th>
                            <th class="p-6 text-right">Contr√¥le</th>
                        </tr>
                    </thead>
                    <tbody id="userMonitoringTable" class="divide-y text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // --- INITIALISATION AVEC MOT DE PASSE ---
        async function loadAdmin() {
            const pass = prompt("Code d'acc√®s Secr√©tariat :");
            if(pass !== "1234") {
                alert("Acc√®s refus√©");
                window.location.href = "dashboard.html";
                return;
            }
            fetchMesses();
            monitorUsers();
            initLiturgieForm();
        }

        // --- 1. LOGIQUE LITURGIE ---
        function initLiturgieForm() {
            const form = document.getElementById('formLiturgie');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    date_jour: new Date().toISOString().split('T')[0],
                    couleur: document.getElementById('litCouleur').value,
                    titre_jour: document.getElementById('litTitreJour').value,
                    lecture1_titre: document.getElementById('litL1Titre').value,
                    lecture1_texte: document.getElementById('litL1Texte').value,
                    psaume_titre: document.getElementById('litPsTitre').value,
                    psaume_texte: document.getElementById('litPsTexte').value,
                    lecture2_titre: document.getElementById('litL2Titre').value,
                    lecture2_texte: document.getElementById('litL2Texte').value,
                    evangile_titre: document.getElementById('litEvTitre').value,
                    evangile_texte: document.getElementById('litEvTexte').value
                };

                const { error } = await _supabase.from('liturgie_maison').upsert([data]);
                if(error) alert("Erreur : " + error.message);
                else alert("‚úÖ Liturgie du jour publi√©e avec succ√®s !");
            };
        }

        // --- 2. LOGIQUE MESSES ---
        async function fetchMesses() {
            const { data: m } = await _supabase.from('demandes_messes').select('*').order('created_at', {ascending: false});
            const table = document.getElementById('adminTable');
            table.innerHTML = m.map(d => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-6">
                        <div class="font-black text-gray-800 text-xs uppercase">${d.nom_beneficiaire}</div>
                        <div class="text-[10px] text-gray-400 italic">${d.details_intention.substring(0,40)}...</div>
                    </td>
                    <td class="p-6 font-mono text-xs text-blue-600 font-bold">${d.transaction_id}</td>
                    <td class="p-6 font-black text-gray-700">${d.montant_offrande} F</td>
                    <td class="p-6 text-right">
                        ${d.statut_paiement === 'en_attente' 
                            ? `<button onclick="validerMesse('${d.id}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg">VALIDER</button>`
                            : `<span class="text-green-600 font-black text-[10px] uppercase">Encaiss√© ‚úÖ</span>`}
                    </td>
                </tr>
            `).join('');
        }

        async function validerMesse(id) {
            if(confirm("Confirmer la r√©ception du paiement ?")) {
                await _supabase.from('demandes_messes').update({ statut_paiement: 'confirme' }).eq('id', id);
                fetchMesses();
            }
        }

        // --- 3. LOGIQUE SURVEILLANCE ---
        async function monitorUsers() {
            const { data: users } = await _supabase.from('profiles').select('*').order('last_seen', { ascending: false });
            const channel = _supabase.channel('online-users');
            let onlineIds = [];

            channel.on('presence', { event: 'sync' }, () => {
                const state = channel.presenceState();
                onlineIds = Object.keys(state);
                renderUserTable(users, onlineIds);
            }).subscribe();
            renderUserTable(users, onlineIds);
        }

        function renderUserTable(users, onlineIds) {
            const table = document.getElementById('userMonitoringTable');
            table.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-6">
                        <div class="font-black text-gray-800 uppercase text-xs">${u.username || 'Inconnu'}</div>
                        <div class="text-[9px] text-gray-400">${u.email || ''}</div>
                    </td>
                    <td class="p-6 text-[10px] font-bold text-gray-500">${new Date(u.last_seen).toLocaleString()}</td>
                    <td class="p-6">
                        ${onlineIds.includes(u.id) 
                            ? '<span class="text-green-600 font-black text-[9px] uppercase italic animate-pulse">‚óè En ligne</span>' 
                            : '<span class="text-gray-300 font-bold text-[9px] uppercase">Hors Ligne</span>'}
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="toggleUserStatus('${u.id}', ${!u.is_active})" class="px-4 py-2 rounded-xl text-[10px] font-black ${u.is_active ? 'bg-red-50 text-red-600' : 'bg-green-600 text-white'}">
                            ${u.is_active ? 'D√âCONNECTER' : 'R√âACTIVER'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleUserStatus(id, status) {
            if(confirm("Confirmer l'action sur ce membre ?")) {
                await _supabase.from('profiles').update({ is_active: status }).eq('id', id);
                location.reload();
            }
        }

        window.onload = loadAdmin;
    </script>
</body>
</html>