<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secr√©tariat | NDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border">
            <div>
                <h1 class="text-2xl font-black text-blue-900 uppercase">Gestion Paroissiale</h1>
                <p class="text-gray-400 text-xs italic font-bold">Secr√©tariat NDA D√©makpo√®</p>
            </div>
            <a href="dashboard.html" class="text-[10px] font-black bg-gray-800 text-white px-4 py-2 rounded-xl hover:bg-gray-700">RETOUR DASHBOARD</a>
        </div>
        
        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border mb-10">
            <div class="p-6 border-b bg-gray-50">
                <h2 class="font-black text-sm uppercase text-gray-500">Demandes de messes √† valider</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400">
                        <tr>
                            <th class="p-4">B√©n√©ficiaire & Intention</th>
                            <th class="p-4">Transaction</th>
                            <th class="p-4">Montant</th>
                            <th class="p-4">Statut / Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminTable" class="divide-y text-sm">
                        <tr><td colspan="4" class="p-10 text-center text-gray-400 italic">Chargement des donn√©es...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h2 class="text-lg font-black mb-4 uppercase text-gray-400 flex items-center gap-2">üë• Membres de la plateforme</h2>
        <div id="listeMembres" class="grid grid-cols-2 md:grid-cols-6 gap-3"></div>
    </div>

    <script src="script.js"></script>
    <script>
        async function loadAdmin() {
            // S√©curit√© basique (√Ä am√©liorer plus tard via les r√¥les Supabase)
            const pass = prompt("Code d'acc√®s Secr√©tariat :"); 
            if(pass !== "1234") {
                alert("Acc√®s refus√©");
                return window.location.href="dashboard.html";
            }
            
            const { data: m, error } = await _supabase.from('demandes_messes').select('*').order('created_at', {ascending: false});
            if(error) return console.error(error);

            const table = document.getElementById('adminTable');
            table.innerHTML = m.length === 0 ? `<tr><td colspan="4" class="p-10 text-center text-gray-400">Aucune demande re√ßue.</td></tr>` : 
            m.map(d => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4 border-b"> 
                        <div class="font-bold text-gray-800 uppercase text-xs">${d.nom_beneficiaire}</div>
                        <div class="text-[10px] text-gray-400 italic leading-tight mt-1 max-w-xs">${d.details_intention || 'Sans d√©tails'}</div>
                        <div class="text-[9px] mt-2 inline-block bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold uppercase">${d.type_priere} - ${d.date_debut}</div>
                    </td>
                    <td class="p-4 border-b">
                        <span class="text-blue-700 font-mono text-xs font-bold">${d.transaction_id}</span><br>
                        <small class="font-bold text-gray-500 uppercase text-[9px]">üì± ${d.info_expediteur}</small>
                    </td>
                    <td class="p-4 border-b font-black text-gray-700">${d.montant_offrande} F</td>
                    <td class="p-4 border-b">
                        ${d.statut_paiement !== 'confirme' ? 
                        `<button onclick="validerDemande('${d.id}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-green-700 transition shadow-md">VALIDER</button>` : 
                        '<span class="text-green-600 font-black text-[10px] border border-green-200 px-3 py-1 rounded-full bg-green-50">‚úÖ VALID√â</span>'}
                    </td>
                </tr>
            `).join('');

            const { data: p } = await _supabase.from('profiles').select('username');
            if(p) {
                document.getElementById('listeMembres').innerHTML = p.map(u => `
                    <div class="bg-white p-3 rounded-2xl shadow-sm text-center text-[10px] font-black border text-gray-600 uppercase italic">üë§ ${u.username}</div>
                `).join('');
            }
        }
        
        async function validerDemande(id) { 
            if(confirm("Confirmer la r√©ception de ce paiement ?")) {
                const { error } = await _supabase.from('demandes_messes').update({ statut_paiement: 'confirme' }).eq('id', id);
                if(error) alert(error.message); else location.reload(); 
            }
        }
        window.onload = loadAdmin;
    </script>
</body>
</html>